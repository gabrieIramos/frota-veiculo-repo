############################################
# Builder stage: compila o projeto com Maven
############################################
FROM maven:3.9.4-openjdk-17-slim AS builder

# Diretório de trabalho
WORKDIR /workspace

# Copia arquivos de build e baixa dependências
COPY pom.xml mvnw ./
COPY .mvn ./
RUN chmod +x mvnw || true

# Copia o código-fonte
COPY src ./src

# Compila o projeto (pulando testes para acelerar)
RUN ./mvnw -B clean package -DskipTests

############################################
# Runtime stage: imagem leve com JRE
############################################
FROM eclipse-temurin:17-jre-jammy

WORKDIR /app

# Copia o JAR construído do builder
COPY --from=builder /workspace/target/*.jar ./app.jar

# Expõe a porta do Spring Boot
EXPOSE 8080

# Executa a aplicação
ENTRYPOINT ["java", "-jar", "/app/app.jar"]
